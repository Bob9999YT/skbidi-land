<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini Mario Kart</title>
<script src="https://sigma-dumahcart-server.vercel.app/socket.io/socket.io.js"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1f1f2f, #1c1c24);
      color: #fff;
    }

    canvas {
      background: #222;
      display: block;
      margin: auto;
      border: 4px solid #444;
      border-radius: 12px;
    }

    .ui {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .screen {
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      background: rgba(0, 0, 0, 0.6);
      animation: fadeIn 0.5s ease;
    }

    .screen.hidden {
      display: none;
    }

    button {
      pointer-events: auto;
      padding: 14px 30px;
      margin: 10px;
      font-size: 1.2rem;
      background: #444;
      color: #fff;
      border: 2px solid #666;
      border-radius: 12px;
      transition: all 0.25s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      cursor: pointer;
    }

    button:hover {
      background: #666;
      transform: scale(1.05);
      border-color: #aaa;
    }

    h1, h2 {
      margin-bottom: 16px;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.98); }
      to { opacity: 1; transform: scale(1); }
    }

    #lobbyList {
      max-height: 200px;
      overflow-y: auto;
      width: 80%;
    }

    #lobbyList button {
      width: 100%;
      text-align: left;
      background: #333;
      margin: 4px 0;
    }
  </style>
</head>
<body>
  <canvas id="game" width="640" height="480"></canvas>
  <div class="ui">
    <div id="title" class="screen">
      <h1>Mini Mario Kart</h1>
      <button id="btnSingle">Single Player</button>
      <button id="btnMulti">Multiplayer</button>
    </div>
    <div id="charSelect" class="screen hidden">
      <h2>Select Your Racer</h2>
      <button class="charBtn" data-color="red">Red</button>
      <button class="charBtn" data-color="blue">Blue</button>
      <button class="charBtn" data-color="green">Green</button>
    </div>
    <div id="trackSelect" class="screen hidden">
      <h2>Select Track</h2>
      <div id="trackButtons"></div>
    </div>
    <div id="diffSelect" class="screen hidden">
      <h2>Select Difficulty</h2>
      <div id="diffButtons"></div>
    </div>
    <div id="lobby" class="screen hidden">
      <h2>Multiplayer Lobby</h2>
      <button id="btnHost">Host Game</button>
      <div id="lobbyList"></div>
      <button id="btnBackLobby">Back</button>
    </div>
    <div id="countdown" class="screen hidden"><h1 id="countText"></h1></div>
    <div id="hud" class="screen hidden" style="background:transparent; flex-direction:row; justify-content:space-between; padding:10px;">
      <div id="lapInfo"></div>
      <div id="posInfo"></div>
      <div id="statusInfo"></div>
    </div>
  </div>
  <script>
    //
    // ——— Setup ———
    //
    const socket = io(); // assumes server on same origin
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const screens = {
      title: document.getElementById('title'),
      char: document.getElementById('charSelect'),
      track: document.getElementById('trackSelect'),
      diff: document.getElementById('diffSelect'),
      lobby: document.getElementById('lobby'),
      countdown: document.getElementById('countdown'),
      hud: document.getElementById('hud')
    };
    const states = {};
    let mode = 'single'; // or 'multi'
    const tracks = ['Green','Desert','Snow','City','Beach'];
    const diffs = ['Easy','Normal','Medium','Hard','Insane'];

    function show(k){ Object.values(screens).forEach(s=>s.classList.add('hidden')); screens[k].classList.remove('hidden'); }

    // title
    document.getElementById('btnSingle').onclick = () => {
      mode='single';
      show('char');
    };
    document.getElementById('btnMulti').onclick = () => {
      mode='multi';
      fetchLobbies();
      show('lobby');
    };

    // character
    document.querySelectorAll('.charBtn').forEach(b=>{
      b.onclick=()=>{
        states.color=b.dataset.color;
        if(mode==='single') show('track');
        else show('lobby');
      };
    });

    // track
    const trackButtons = document.getElementById('trackButtons');
    tracks.forEach((t,i)=> {
      const b = document.createElement('button');
      b.textContent=t;
      b.onclick=()=>{ states.track=i; mode==='single'?show('diff'):null; };
      trackButtons.appendChild(b);
    });
    // difficulty
    const diffButtons = document.getElementById('diffButtons');
    diffs.forEach(d=>{
      const b = document.createElement('button');
      b.textContent=d;
      b.onclick=()=>{
        states.diff=d; states.laps=3; states.trackCount=0; states.pos=1;
        startRace();
      };
      diffButtons.appendChild(b);
    });

    //
    // ——— Multiplayer Lobby ———
    //
    const lobbyList = document.getElementById('lobbyList');
    document.getElementById('btnHost').onclick = () => {
      socket.emit('hostLobby', { track:0, color: states.color });
    };
    document.getElementById('btnBackLobby').onclick = () => show('title');

    socket.on('lobbies', list => {
      lobbyList.innerHTML = '';
      list.forEach(l=> {
        const b = document.createElement('button');
        b.textContent = `Room ${l.id} (${l.count} players)`;
        b.onclick=()=> {
          socket.emit('joinLobby', { id:l.id, color:states.color });
        };
        lobbyList.appendChild(b);
      });
    });

    socket.on('joinedLobby', data => {
      states.lobbyId=data.id;
      show('countdown');
      states.laps=3; states.trackCount=0;
      playCountdown(3, ()=> loop(true));
    });

    //
    // ——— Race Flow ———
    //
    function startRace(){
      playCountdown(3, ()=> loop(false));
    }
    function playCountdown(c, done){
      const ct = document.getElementById('countText');
      show('countdown');
      ct.textContent = c>0?c:'GO!';
      setTimeout(()=>{
        if(c>0) playCountdown(c-1,done);
        else { show('hud'); done(); }
      },1000);
    }

    //
    // ——— Main Loop ———
    //
    const keys = {};
    window.onkeydown = e=> keys[e.key]=1;
    window.onkeyup   = e=> keys[e.key]=0;

    function loop(isMulti){
      update(isMulti);
      draw();
      if(states.trackCount < tracks.length) requestAnimationFrame(()=>loop(isMulti));
      else finishGP(isMulti);
    }

    function update(isMulti){
      // simple physics
      states.x = (states.x||320) + ((keys.ArrowRight?2:keys.ArrowLeft?-2:0));
      states.y = (states.y||240) + ((keys.ArrowUp? -2:keys.ArrowDown?2:0));
      // wrap
      states.x = (states.x+640)%640;
      states.y = (states.y+480)%480;

      if(isMulti){
        socket.emit('playerMove', { x:states.x, y:states.y });
      }
    }

    function draw(){
      ctx.clearRect(0,0,640,480);
      ctx.fillStyle = ['#0a0','#a60','#0af','#666','#fa0'][states.track||0];
      ctx.fillRect(0,0,640,480);
      ctx.fillStyle = states.color||'red';
      ctx.fillRect((states.x||320)-10,(states.y||240)-10,20,20);
      document.getElementById('lapInfo').textContent = '';
      document.getElementById('posInfo').textContent = '';
      document.getElementById('statusInfo').textContent = '';
    }

    function finishGP(isMulti){
      alert((isMulti?'Online ':'Single ')+'Grand Prix Finished 🤝');
      show('title');
    }

    //
    // ——— Lobby Refresh ———
    //
    function fetchLobbies(){
      socket.emit('listLobbies');
    }
    socket.on('updateLobbies',fetchLobbies);

    //
    // ——— Connect errors ———
    //
    socket.on('connect_error', e=>alert('Cannot connect to server'));

  </script>
</body>
</html>
