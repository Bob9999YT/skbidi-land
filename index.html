<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Connect Four</title>
<style>
  * {
    box-sizing: border-box;
  }
  html, body {
    margin: 0; padding: 0; height: 100%; width: 100%;
    background-color: #1e1e2f;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #fff;
  }
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    min-height: 100vh;
  }
  h1 {
    font-size: 2rem;
    color: #ffaa00;
    margin-bottom: 1rem;
    text-align: center;
  }
  .menu {
    display: flex;
    flex-wrap: wrap;
    gap: 12px 16px;
    justify-content: center;
    align-items: center;
    margin-bottom: 15px;
    width: 100%;
    max-width: 600px;
  }
  .menu label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 600;
    white-space: nowrap;
    font-size: 1rem;
  }
  select, button {
    font-size: 1rem;
    padding: 8px 14px;
    border-radius: 6px;
    border: 2px solid #ffaa00;
    background: #29293d;
    color: white;
    cursor: pointer;
    box-shadow: 0 3px 0 #ffaa00;
    transition: all 0.2s ease;
    min-width: 90px;
  }
  select {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
  }
  select:hover, button:hover {
    transform: scale(1.05);
  }
  button:active {
    transform: scale(0.97);
    box-shadow: 0 1px 0 #ffaa00;
  }
  #aiDifficultyButtons {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 10px;
    width: 100%;
    max-width: 600px;
  }
  #aiDifficultyButtons button {
    min-width: 70px;
    padding: 6px 12px;
    font-size: 0.9rem;
    border-radius: 4px;
    border: 1.5px solid #ffaa00;
    background: #29293d;
    box-shadow: 0 2px 0 #ffaa00;
  }
  #aiDifficultyButtons button.active {
    background: #ffaa00;
    color: #111;
    box-shadow: none;
    transform: scale(1.1);
  }
  #aiDifficultyButtons button:hover:not(.active) {
    background: #ffaa00;
    color: #111;
    transform: scale(1.1);
  }
  canvas {
    background: #29293d;
    border-radius: 12px;
    box-shadow: 0 0 10px #0008;
    margin: 20px 0;
    cursor: pointer;
    max-width: 100%;
    height: auto;
  }
  #status {
    font-size: 1.1rem;
    font-weight: 700;
    margin-top: 5px;
    min-height: 24px;
    text-align: center;
    max-width: 600px;
  }
  #matchList {
    margin-top: 15px;
    max-width: 600px;
    width: 100%;
    text-align: left;
    color: white;
  }
  #matchList h3 {
    color: #ffaa00;
    margin-bottom: 10px;
    text-align: center;
  }
  #matchesContainer {
    max-height: 240px;
    overflow-y: auto;
  }
  .matchItem {
    background: #29293d;
    border-radius: 6px;
    padding: 8px 12px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 3px 0 #ffaa00;
  }
  .matchItem .playerInfo {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .matchItem .playerInfo img {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    object-fit: cover;
  }
  .matchItem button {
    background: #ffaa00;
    border: none;
    border-radius: 4px;
    color: #111;
    padding: 6px 12px;
    cursor: pointer;
    transition: transform 0.15s ease;
    font-size: 0.9rem;
    box-shadow: none;
  }
  .matchItem button:hover {
    transform: scale(1.1);
  }
  /* Scrollbar styling for match list */
  #matchesContainer::-webkit-scrollbar {
    width: 8px;
  }
  #matchesContainer::-webkit-scrollbar-thumb {
    background-color: #ffaa00;
    border-radius: 4px;
  }
</style>
</head>
<body>
  <h1>Connect Four</h1>

  <div class="menu">
    <label for="rows">Rows:</label>
    <select id="rows" name="rows"></select>

    <label for="cols">Columns:</label>
    <select id="cols" name="cols"></select>

    <label for="mode">Mode:</label>
    <select id="mode" name="mode">
      <option value="pvp">Player vs Player</option>
      <option value="ai">Player vs AI</option>
    </select>

    <button id="create">Create Game</button>
    <button id="leave" disabled>Leave Game</button>
  </div>

  <div id="aiDifficultyButtons" style="display:none;">
    <button data-level="easy">Easy</button>
    <button data-level="normal" class="active">Normal</button>
    <button data-level="hard">Hard</button>
    <button data-level="insane">Insane</button>
    <button data-level="impossible">Impossible</button>
  </div>

  <canvas id="gameCanvas" width="490" height="420"></canvas>
  <div id="status">6 7 wheres the mangos</div>

  <div id="matchList">
    <h3>Available Matches</h3>
    <div id="matchesContainer">No matches available.</div>
  </div>

<script>
  const PLAYER_NONE = 0, PLAYER_RED = 1, PLAYER_YELLOW = 2;
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  const statusText = document.getElementById('status');
  const matchesContainer = document.getElementById('matchesContainer');

  const rowSel = document.getElementById('rows');
  const colSel = document.getElementById('cols');
  const modeSel = document.getElementById('mode');
  const createBtn = document.getElementById('create');
  const leaveBtn = document.getElementById('leave');
  const aiDifficultyDiv = document.getElementById('aiDifficultyButtons');
  const aiButtons = aiDifficultyDiv.querySelectorAll('button');

  let rows = 6, cols = 7;
  let board = [];
  let currentPlayer = PLAYER_RED;
  let gameState = 'idle';
  let myPlayer = PLAYER_NONE;
  let gameId = null;
  let gameMode = 'pvp';
  let currentGame = null;
  let aiDifficulty = 'normal';
  let discordUser = null;
  let matches = {};

  function setupUI() {
    for(let i=4; i<=10; i++) {
      rowSel.add(new Option(i, i));
      colSel.add(new Option(i, i));
    }
    rowSel.value = rows;
    colSel.value = cols;

    rowSel.onchange = () => { rows = +rowSel.value; updateCanvasSize(); };
    colSel.onchange = () => { cols = +colSel.value; updateCanvasSize(); };
    modeSel.onchange = () => {
      gameMode = modeSel.value;
      toggleAIDifficulty(gameMode === 'ai');
    };

    createBtn.onclick = onCreate;
    leaveBtn.onclick = onLeave;
    canvas.addEventListener('click', onClick);

    aiButtons.forEach(btn => {
      btn.onclick = () => {
        aiButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        aiDifficulty = btn.getAttribute('data-level');
        setStatus(`AI difficulty set to ${aiDifficulty}`);
      };
    });

    toggleAIDifficulty(false);
    updateUIButtons();
    renderMatchList();
  }

  function toggleAIDifficulty(show) {
    aiDifficultyDiv.style.display = show ? 'flex' : 'none';
  }

  function updateCanvasSize() {
    canvas.width = cols * 70;
    canvas.height = rows * 70;
    drawBoard();
  }

  function setStatus(text) {
    statusText.textContent = text;
  }

  function updateUIButtons() {
    leaveBtn.disabled = !(gameState === 'playing' || gameState === 'waiting' || gameState === 'ended');
    createBtn.disabled = (gameState === 'playing' || gameState === 'waiting');
  }

  function initBoard() {
    board = Array.from({length: rows}, () => Array(cols).fill(PLAYER_NONE));
    updateCanvasSize();
  }

  function drawBoard() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for(let y=0; y<rows; y++){
      for(let x=0; x<cols; x++){
        ctx.fillStyle = board[y][x] === PLAYER_RED ? "#f44336" :
                        board[y][x] === PLAYER_YELLOW ? "#fdd835" : "white";
        ctx.beginPath();
        ctx.arc(35 + x*70, 35 + y*70, 30, 0, 2*Math.PI);
        ctx.fill();
      }
    }
  }

  function onCreate() {
    rows = +rowSel.value;
    cols = +colSel.value;
    gameMode = modeSel.value;

    initBoard();
    gameId = Math.random().toString(36).substr(2,8);

    currentGame = {
      id: gameId,
      rows,
      cols,
      mode: gameMode,
      difficulty: aiDifficulty,
      state: gameMode === 'ai' ? 'playing' : 'waiting',
      owner: discordUser,
    };

    myPlayer = PLAYER_RED;
    currentPlayer = PLAYER_RED;
    gameState = currentGame.state;

    if(gameMode === 'ai'){
      setStatus("Your turn!");
      toggleMatchList(false);
    } else {
      setStatus("Waiting for opponent...");
      toggleMatchList(true);
      addMatch(currentGame);
    }
    broadcast({type:'create', game: currentGame});
    updateUIButtons();
  }

  function onJoinGame(id) {
    if(!matches[id]){
      setStatus("Match not found.");
      return;
    }
    currentGame = matches[id];
    rows = currentGame.rows;
    cols = currentGame.cols;
    gameId = currentGame.id;
    myPlayer = PLAYER_YELLOW;
    currentPlayer = PLAYER_RED;
    gameState = 'playing';

    initBoard();
    setStatus(currentPlayer === myPlayer ? "Your turn!" : "Opponent's turn...");
    broadcast({type:'join', gameId});
    toggleMatchList(false);
    updateUIButtons();

    if(gameMode === 'ai' && currentPlayer !== myPlayer){
      setTimeout(aiMove, 500);
    }
  }

  function onLeave() {
    if(!currentGame) return;
    if(discordUser && currentGame.owner && discordUser.id === currentGame.owner.id){
      // Owner leaves: delete the match
      broadcast({type:'leave', gameId});
      removeMatch(gameId);
      resetGame();
      toggleMatchList(true);
      setStatus("You left and deleted your match.");
    } else {
      // Player leaves: notify player leave only
      broadcast({type:'playerLeave', gameId, playerId: discordUser?.id});
      resetGame();
      toggleMatchList(true);
      setStatus("You left the match.");
    }
  }

  function resetGame() {
    gameState = 'idle';
    currentGame = null;
    board = [];
    myPlayer = PLAYER_NONE;
    gameId = null;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    setStatus("6 7 wheres the mangos");
    updateUIButtons();
  }

  function addMatch(game) {
    matches[game.id] = game;
    renderMatchList();
  }

  function removeMatch(id) {
    delete matches[id];
    renderMatchList();
  }

  function renderMatchList() {
    const availableMatches = Object.values(matches)
      .filter(m => m.state === 'waiting')
      .filter(m => !(discordUser && m.owner && discordUser.id === m.owner.id)); // Hide your own matches

    if(availableMatches.length === 0){
      matchesContainer.textContent = "No matches available.";
      return;
    }
    matchesContainer.innerHTML = "";

    availableMatches.forEach(m => {
      const div = document.createElement('div');
      div.className = "matchItem";

      // Player info with avatar and name
      const playerInfo = document.createElement('div');
      playerInfo.className = "playerInfo";

      const avatarImg = document.createElement('img');
      avatarImg.src = m.owner?.avatar || 'https://cdn.discordapp.com/embed/avatars/0.png';
      avatarImg.alt = "Avatar";

      const usernameSpan = document.createElement('span');
      usernameSpan.textContent = m.owner?.username || "Unknown";

      playerInfo.appendChild(avatarImg);
      playerInfo.appendChild(usernameSpan);

      const matchText = document.createElement('span');
      matchText.textContent = `Match ${m.id} (${m.rows}x${m.cols}) Mode: ${m.mode}`;

      const btn = document.createElement('button');
      btn.textContent = "Join";
      btn.onclick = () => onJoinGame(m.id);

      div.appendChild(playerInfo);
      div.appendChild(matchText);
      div.appendChild(btn);

      matchesContainer.appendChild(div);
    });
  }

  function onClick(e) {
    if(gameState !== 'playing' || myPlayer !== currentPlayer) return;

    const col = Math.floor(e.offsetX / 70);
    if(col < 0 || col >= cols) return;

    for(let y=rows-1; y>=0; y--){
      if(board[y][col] === PLAYER_NONE){
        board[y][col] = myPlayer;
        drawBoard();
        broadcast({type:'move', col, row: y, player: myPlayer, gameId});

        if(checkWin()){
          gameState = 'ended';
          setStatus("You win!");
          broadcast({type:'end', winner: myPlayer, gameId});
        } else if(isBoardFull()){
          gameState = 'ended';
          setStatus("Draw!");
          broadcast({type:'end', winner: PLAYER_NONE, gameId});
        } else {
          currentPlayer = currentPlayer === PLAYER_RED ? PLAYER_YELLOW : PLAYER_RED;
          setStatus(currentPlayer === myPlayer ? "Your turn!" : "Opponent's turn...");
          if(gameMode === 'ai' && currentPlayer !== myPlayer){
            setTimeout(aiMove, 500);
          }
        }
        break;
      }
    }
  }

  function isBoardFull(){
    return board.every(row => row.every(cell => cell !== PLAYER_NONE));
  }

  function checkWin(){
    // Horizontal, vertical, diagonal checks
    function checkDir(r, c, dr, dc){
      let count = 0;
      let player = board[r][c];
      let rr = r, cc = c;
      while(rr >= 0 && rr < rows && cc >= 0 && cc < cols && board[rr][cc] === player){
        count++; rr += dr; cc += dc;
      }
      return count;
    }

    for(let r=0; r<rows; r++){
      for(let c=0; c<cols; c++){
        if(board[r][c] === PLAYER_NONE) continue;
        let player = board[r][c];
        if(
          checkDir(r, c, 0, 1) + checkDir(r, c, 0, -1) - 1 >= 4 ||
          checkDir(r, c, 1, 0) + checkDir(r, c, -1, 0) - 1 >= 4 ||
          checkDir(r, c, 1, 1) + checkDir(r, c, -1, -1) - 1 >= 4 ||
          checkDir(r, c, 1, -1) + checkDir(r, c, -1, 1) - 1 >= 4
        ){
          return true;
        }
      }
    }
    return false;
  }

  // AI moves (simple normal AI for demo)
  function aiMove(){
    if(gameState !== 'playing' || currentPlayer === myPlayer) return;

    // Simple AI: picks random valid column
    const validCols = [];
    for(let c=0; c<cols; c++){
      if(board[0][c] === PLAYER_NONE) validCols.push(c);
    }
    if(validCols.length === 0) return;

    const col = validCols[Math.floor(Math.random()*validCols.length)];
    for(let r=rows-1; r>=0; r--){
      if(board[r][col] === PLAYER_NONE){
        board[r][col] = currentPlayer;
        drawBoard();
        broadcast({type:'move', col, row: r, player: currentPlayer, gameId});

        if(checkWin()){
          gameState = 'ended';
          setStatus("AI wins!");
          broadcast({type:'end', winner: currentPlayer, gameId});
        } else if(isBoardFull()){
          gameState = 'ended';
          setStatus("Draw!");
          broadcast({type:'end', winner: PLAYER_NONE, gameId});
        } else {
          currentPlayer = currentPlayer === PLAYER_RED ? PLAYER_YELLOW : PLAYER_RED;
          setStatus(currentPlayer === myPlayer ? "Your turn!" : "Opponent's turn...");
        }
        break;
      }
    }
  }

  // Broadcast helper (stub for DiscordSDK or custom)
  function broadcast(data){
    if(typeof DiscordSDK !== "undefined"){
      DiscordSDK.activity.broadcast(data);
    } else {
      // Local testing - log to console or implement local message passing
      console.log("Broadcast:", data);
    }
  }

  // Event handler for broadcasted messages
  function handleEvent(data){
    if(data.game?.id){
      addMatch(data.game);
    }
    if(data.gameId && gameId && data.gameId !== gameId) return;

    switch(data.type){
      case 'create':
        addMatch(data.game);
        break;
      case 'join':
        if(matches[data.gameId]){
          matches[data.gameId].state = 'playing';
          if(gameId === data.gameId){
            gameState = 'playing';
            setStatus(currentPlayer === myPlayer ? "Your turn!" : "Opponent's turn...");
            toggleMatchList(false);
            updateUIButtons();
            if(gameMode === 'ai' && currentPlayer !== myPlayer){
              setTimeout(aiMove, 500);
            }
          }
          renderMatchList();
        }
        break;
      case 'move':
        board[data.row][data.col] = data.player;
        drawBoard();
        currentPlayer = data.player === PLAYER_RED ? PLAYER_YELLOW : PLAYER_RED;
        setStatus(currentPlayer === myPlayer ? "Your turn!" : "Opponent's turn...");
        break;
      case 'end':
        gameState = 'ended';
        setStatus(data.winner === myPlayer ? "You win!" : "You lose.");
        updateUIButtons();
        toggleMatchList(true);
        break;
      case 'leave':
        removeMatch(data.gameId);
        if(gameId === data.gameId){
          resetGame();
          toggleMatchList(true);
        }
        break;
      case 'playerLeave':
        // Player left a match but match remains, no direct effect here
        break;
    }
  }

  // Initialize Discord user info
  function setupDiscordUser(){
    if(typeof DiscordSDK !== "undefined"){
      DiscordSDK.ready().then(() => {
        DiscordSDK.getCurrentUser().then(user => {
          discordUser = {
            id: user.id,
            username: user.username,
            avatar: user.avatar_url
          };
          setStatus("6 7 wheres the mangos");
        });
        DiscordSDK.activity.on('broadcast', handleEvent);
      });
    } else {
      setStatus("6 7 wheres the mangos");
    }
  }

  function toggleMatchList(show){
    document.getElementById('matchList').style.display = show ? 'block' : 'none';
  }

  function init(){
    setupUI();
    setupDiscordUser();
    initBoard();
  }

  init();
</script>
</body>
</html>
