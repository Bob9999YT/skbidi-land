<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Connect Four</title>
  <style>
    /* (entire CSS from your original code, with avatar-circle img overflow handling) */
    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0; height: 100%; width: 100%;
      background-color: #1e1e2f;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #fff;
    }
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      min-height: 100vh;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      max-width: 600px;
      margin-bottom: 20px;
    }
    h1 {
      font-size: 2rem;
      color: #ffaa00;
      margin: 0;
      text-align: center;
    }
    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #29293d;
      padding: 8px 12px;
      border-radius: 8px;
      border: 2px solid #ffaa00;
      user-select: none;
    }
    .user-profile .avatar-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: #ffaa00;
      color: #111;
      font-weight: 700;
      font-size: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      text-transform: uppercase;
      overflow: hidden;
    }
    .user-profile .avatar-circle img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }
    .user-profile span {
      font-weight: 600;
      color: #ffaa00;
    }
    /* (rest of your original styles) */
  </style>
</head>
<body>

<!-- Username prompt & avatar URL -->
<div id="usernamePromptContainer">
  <h2 style="color:#ffaa00; margin-bottom:10px;">Enter Your Username</h2>
  <input id="usernameInput" type="text" maxlength="16" placeholder="Your username" />
  <input id="avatarUrlInput" type="text" placeholder="Avatar Image/GIF URL (optional)"
         style="margin:10px 0; padding:8px; width:100%; background:#1f1f2b; color:white; border:2px solid #ffaa00; border-radius:6px;" />
  <button id="usernameSubmit" disabled>Start Playing</button>
</div>

<!-- Header with avatar -->
<div class="header" style="display:none;">
  <h1>Connect Four</h1>
  <div class="user-profile">
    <div class="avatar-circle" id="userAvatar">G</div>
    <span id="username">Guest</span>
  </div>
</div>

<!-- Menu -->
<div class="menu" style="display:none;">
  <label>Rows:<select id="rows"></select></label>
  <label>Columns:<select id="cols"></select></label>
  <label>Mode:<select id="mode">
    <option value="pvp">Player vs Player</option>
    <option value="ai">Player vs AI</option>
  </select></label>
  <button id="create">Create Game</button>
  <button id="leave" disabled>Leave Game</button>
</div>

<!-- AI difficulty -->
<div id="aiDifficultyButtons" style="display:none;">
  <button data-level="easy">Easy</button>
  <button data-level="normal" class="active">Normal</button>
  <button data-level="hard">Hard</button>
  <button data-level="insane">Insane</button>
  <button data-level="impossible">Impossible</button>
</div>

<!-- Canvas & status -->
<canvas id="gameCanvas" width="490" height="420" style="display:none;"></canvas>
<div id="status" style="display:none; max-width:600px; text-align:center; margin:10px 0;"></div>

<!-- Match list -->
<div id="matchList" style="display:none; max-width:600px; width:100%;">
  <h3 style="color:#ffaa00; text-align:center;">Available Matches</h3>
  <button id="refreshMatchesBtn">Refresh Matches</button>
  <div id="matchesContainer" style="max-height:240px; overflow-y:auto; padding:8px; background:#1f1f2b; border:1.5px solid #ffaa00; border-radius:6px;">
    <div class="no-matches" style="text-align:center; color:#888;">No matches available.</div>
  </div>
</div>

<script>
(() => {
  const PLAYER_NONE=0, PLAYER_RED=1, PLAYER_YELLOW=2;
  let currentUser={username:null,avatarUrl:null}, currentUserId=null;
  let rows=6,cols=7, board=[], currentPlayer=PLAYER_RED;
  let gameState='idle', myPlayer=PLAYER_NONE, gameId=null, gameMode='pvp', aiDifficulty='normal';
  let isInMatch=false;
  const STORAGE_KEY='connect_four_global_matches';
  const matches={};

  // DOM
  const usernamePrompt=document.getElementById('usernamePromptContainer');
  const usernameInput=document.getElementById('usernameInput');
  const avatarUrlInput=document.getElementById('avatarUrlInput');
  const usernameSubmit=document.getElementById('usernameSubmit');
  const header=document.querySelector('.header');
  const userAvatarDiv=document.getElementById('userAvatar');
  const usernameSpan=document.getElementById('username');
  const menu=document.querySelector('.menu');
  const rowSel=document.getElementById('rows'), colSel=document.getElementById('cols'), modeSel=document.getElementById('mode');
  const createBtn=document.getElementById('create'), leaveBtn=document.getElementById('leave');
  const aiDiv=document.getElementById('aiDifficultyButtons'), aiBtns=aiDiv.querySelectorAll('button');
  const canvas=document.getElementById('gameCanvas'), ctx=canvas.getContext('2d');
  const statusText=document.getElementById('status');
  const matchListDiv=document.getElementById('matchList'), matchesContainer=document.getElementById('matchesContainer');
  const refreshBtn=document.getElementById('refreshMatchesBtn');

  function getAvatarColor(name) {
    let hash=0;
    for (let c of name) hash = c.charCodeAt(0) + ((hash<<5)-hash);
    const colors=['#f44336','#e91e63','#9c27b0','#673ab7','#3f51b5','#2196f3','#03a9f4','#00bcd4','#009688','#4caf50','#8bc34a','#cddc39','#ffeb3b','#ffc107','#ff9800','#ff5722'];
    return colors[Math.abs(hash)%colors.length];
  }

  function updateUserProfile() {
    usernameSpan.textContent=currentUser.username;
    userAvatarDiv.innerHTML='';
    if (currentUser.avatarUrl && currentUser.avatarUrl.startsWith('http')) {
      let img=document.createElement('img');
      img.src=currentUser.avatarUrl; img.alt=currentUser.username;
      userAvatarDiv.appendChild(img);
    } else {
      let letter=currentUser.username.charAt(0).toUpperCase();
      userAvatarDiv.textContent=letter;
      userAvatarDiv.style.backgroundColor=getAvatarColor(currentUser.username);
    }
  }

  function initBoard() {
    board=Array.from({length:rows},()=>Array(cols).fill(PLAYER_NONE));
    updateCanvasSize();
  }
  function updateCanvasSize(){
    canvas.width=cols*70; canvas.height=rows*70;
    drawBoard();
  }
  function drawBoard(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='#ffaa00'; ctx.fillRect(0,0,canvas.width,canvas.height);
    for (let r=0;r<rows;r++) for (let c=0;c<cols;c++){
      let x=c*70, y=r*70;
      ctx.fillStyle='#1e1e2f';
      ctx.beginPath(); ctx.arc(x+35,y+35,30,0,2*Math.PI); ctx.fill();
      if (board[r][c]===PLAYER_RED){
        ctx.fillStyle='#ff3333'; ctx.beginPath(); ctx.arc(x+35,y+35,27,0,2*Math.PI); ctx.fill();
      } else if (board[r][c]===PLAYER_YELLOW){
        ctx.fillStyle='#ffff66'; ctx.beginPath(); ctx.arc(x+35,y+35,27,0,2*Math.PI); ctx.fill();
      }
    }
  }

  function findLowestEmptyRow(col){
    for (let r=rows-1;r>=0;r--) if (board[r][col]===PLAYER_NONE) return r;
    return -1;
  }
  function checkWin(player){
    for(let r=0;r<rows;r++) for(let c=0;c<=cols-4;c++)
      if ([0,1,2,3].every(i=>board[r][c+i]===player)) return true;
    for(let c=0;c<cols;c++) for(let r=0;r<=rows-4;r++)
      if ([0,1,2,3].every(i=>board[r+i][c]===player)) return true;
    for(let r=3;r<rows;r++) for(let c=0;c<=cols-4;c++)
      if ([0,1,2,3].every(i=>board[r-i][c+i]===player)) return true;
    for(let r=0;r<=rows-4;r++) for(let c=0;c<=cols-4;c++)
      if ([0,1,2,3].every(i=>board[r+i][c+i]===player)) return true;
    return false;
  }
  function checkDraw(){
    return board[0].every(cell=>cell!==PLAYER_NONE);
  }

  function loadGlobalMatches(){
    let d=localStorage.getItem(STORAGE_KEY);
    if (!d) return {};
    try { return JSON.parse(d) } catch { return {} }
  }
  function saveGlobalMatches(){
    localStorage.setItem(STORAGE_KEY,JSON.stringify(matches));
    window.dispatchEvent(new Event('storage'));
  }

  function refreshMatchesList(){
    matchesContainer.innerHTML='';
    let any=false;
    Object.values(matches).forEach(m=> {
      if (m.mode!=='pvp'||m.status!=='waiting'||m.creatorId===currentUserId) return;
      any=true;
      let div=document.createElement('div'); div.className='matchItem';
      let infoDiv=document.createElement('div'); infoDiv.className='playerInfo';
      let avatar=document.createElement('div'); avatar.className='avatar-circle'; avatar.textContent=m.creatorName.charAt(0).toUpperCase();
      avatar.style.backgroundColor=getAvatarColor(m.creatorName);
      let nameSpan=document.createElement('span'); nameSpan.textContent=m.creatorName;
      infoDiv.append(avatar,nameSpan);
      let btn=document.createElement('button'); btn.textContent='Join'; btn.disabled=isInMatch; btn.onclick=()=>joinMatch(m.id);
      div.append(infoDiv,btn);
      matchesContainer.appendChild(div);
    });
    if (!any) matchesContainer.innerHTML='<div class="no-matches" style="text-align:center;color:#888;">No matches available.</div>';
  }

  function makeId(){return 'match_'+Math.random().toString(36).substr(2,9)}

  function updateUIForMatch(){
    let inM=isInMatch;
    createBtn.disabled=inM; rowSel.disabled=inM;
    colSel.disabled=inM; modeSel.disabled=inM;
    leaveBtn.disabled=!inM;
    canvas.style.display=inM?'block':'none';
    statusText.style.display='block';
    matchListDiv.style.display=(inM&&gameMode==='pvp')||(!inM)?'block':'none';
    aiDiv.style.display=inM&&gameMode==='ai'?'flex':'none';
    if (!inM && gameMode==='pvp') refreshMatchesList();
  }

  function updateStatus(t){ statusText.textContent=t }

  function createMatch(){
    if(isInMatch) return;
    rows=parseInt(rowSel.value); cols=parseInt(colSel.value); gameMode=modeSel.value;
    gameId=makeId();
    currentPlayer=PLAYER_RED; myPlayer=PLAYER_RED;
    gameState=gameMode==='pvp'?'waiting':'playing';
    initBoard();
    if(gameMode==='pvp'){
      matches[gameId]={id:gameId,creatorId:currentUserId,creatorName:currentUser.username,rows,cols,mode:'pvp',status:'waiting',board:JSON.parse(JSON.stringify(board)),currentTurn:currentPlayer};
      saveGlobalMatches();
      updateStatus('Waiting for opponent to joinâ€¦');
    }else{ updateStatus("Your turn"); }
    isInMatch=true; leaveBtn.disabled=false; drawBoard(); updateUIForMatch();
  }

  function joinMatch(id){
    if (isInMatch||!matches[id]||matches[id].status!=='waiting'||matches[id].creatorId===currentUserId) return;
    let m=matches[id];
    gameId=id; gameMode='pvp'; rows=m.rows; cols=m.cols;
    board=JSON.parse(JSON.stringify(m.board));
    currentPlayer=m.currentTurn; myPlayer=PLAYER_YELLOW;
    gameState='playing'; matches[id].status='playing';
    saveGlobalMatches(); drawBoard();
    isInMatch=true; leaveBtn.disabled=false;
    updateStatus(currentPlayer===myPlayer?"Your turn":"Opponent's turn");
    updateUIForMatch();
  }

  function leaveMatch(){
    if (!isInMatch) return;
    if(gameMode==='pvp'&&gameId&&matches[gameId]){
      delete matches[gameId];
      saveGlobalMatches();
    }
    isInMatch=false; gameState='idle'; myPlayer=PLAYER_NONE; gameId=null;
    board=[]; updateStatus('Left the match.');
    ctx.clearRect(0,0,canvas.width,canvas.height);
    updateUIForMatch();
  }

  canvas.onclick = e=>{
    if(gameState!=='playing'||!isInMatch||(gameMode==='pvp'?currentPlayer!==myPlayer:currentPlayer!==myPlayer)) return;
    let rect=canvas.getBoundingClientRect();
    let col=Math.floor((e.clientX-rect.left)/70);
    if(col<0||col>=cols) return;
    makeMove(col);
  };

  function makeMove(col){
    if(gameState!=='playing') return;
    let r=findLowestEmptyRow(col); if(r<0) return;
    board[r][col]=currentPlayer; drawBoard(); 
    if(checkWin(currentPlayer)){
      gameState='ended';
      updateStatus(currentPlayer===myPlayer? "You win!" : (gameMode==='ai'? "AI wins!" : "Opponent wins!"));
      leaveBtn.disabled=false; return;
    }
    if(checkDraw()){
      gameState='ended';
      updateStatus("It's a draw!"); leaveBtn.disabled=false; return;
    }
    currentPlayer = currentPlayer===PLAYER_RED?PLAYER_YELLOW:PLAYER_RED;
    if(gameMode==='pvp'){
      updateStatus(currentPlayer===myPlayer?"Your turn":"Opponent's turn");
      if(gameId) matches[gameId].currentTurn=currentPlayer, saveGlobalMatches();
    } else {
      if(currentPlayer===myPlayer){ updateStatus("Your turn"); }
      else {
        updateStatus("AI's turn");
        setTimeout(aiMove,700);
      }
    }
  }

  function aiMove(){
    if(gameState!=='playing'||currentPlayer===myPlayer) return;
    let valid=[];
    for(let c=0;c<cols;c++) if(findLowestEmptyRow(c)>=0) valid.push(c);
    if(valid.length===0) return;
    makeMove(valid[Math.floor(Math.random()*valid.length)]);
  }

  refreshBtn.onclick = ()=>{
    refreshBtn.style.transform='scale(0.97)';
    refreshBtn.style.boxShadow='0 1px 0 #ffaa00';
    setTimeout(()=>{refreshBtn.style.transform='';refreshBtn.style.boxShadow='';},150);
    let data=loadGlobalMatches();
    Object.keys(matches).forEach(k=>delete matches[k]);
    Object.assign(matches,data);
    refreshMatchesList();
  };

  window.addEventListener('storage',e=>{
    if(e.key===STORAGE_KEY){
      let data=loadGlobalMatches();
      Object.keys(matches).forEach(k=>delete matches[k]);
      Object.assign(matches,data);
      refreshMatchesList();
      if(isInMatch&&gameMode==='pvp'&&gameId&&!matches[gameId]){
        alert("Your match was ended.");
        leaveMatch();
      }
    }
  });

  setInterval(()=>{
    if(gameMode==='pvp'&&!isInMatch){
      let data=loadGlobalMatches();
      Object.keys(matches).forEach(k=>delete matches[k]);
      Object.assign(matches,data);
      refreshMatchesList();
    }
  },5000);

  // populate selectors
  for(let r=4;r<=10;r++){let o=document.createElement('option');o.value=r;o.textContent=r; if(r===rows)o.selected=true; rowSel.append(o)}
  for(let c=4;c<=10;c++){let o=document.createElement('option');o.value=c;o.textContent=c; if(c===cols)o.selected=true; colSel.append(o)}

  aiBtns.forEach(btn=>{
    btn.onclick=()=>{
      aiBtns.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      aiDifficulty=btn.dataset.level;
    };
  });

  usernameInput.addEventListener('input',()=>{
    usernameSubmit.disabled=usernameInput.value.trim().length<2;
  });

  usernameSubmit.onclick=()=>{
    currentUser.username=usernameInput.value.trim();
    currentUser.avatarUrl=avatarUrlInput.value.trim();
    if(currentUser.username.length<2) return;
    currentUserId='user_'+Math.random().toString(36).slice(2,10);
    usernamePrompt.style.display='none';
    header.style.display='flex';
    menu.style.display='flex';
    statusText.style.display='block';
    matchListDiv.style.display='block';
    updateUserProfile();
    initBoard();
    updateStatus('Click "Create Game" to start playing!');
    refreshMatchesList();
  };

  createBtn.onclick=()=>createMatch();
  leaveBtn.onclick=()=>leaveMatch();
})();
</script>

</body>
</html>
