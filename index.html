<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Connect Four</title>
  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0; height: 100%; width: 100%;
      background-color: #1e1e2f;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #fff;
    }
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      min-height: 100vh;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      max-width: 600px;
      margin-bottom: 20px;
    }
    h1 {
      font-size: 2rem;
      color: #ffaa00;
      margin: 0;
      text-align: center;
    }
    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #29293d;
      padding: 8px 12px;
      border-radius: 8px;
      border: 2px solid #ffaa00;
      user-select: none;
    }
    .user-profile .avatar-circle {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background-color: #ffaa00;
      font-size: 16px;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    .user-profile .avatar-circle img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }
    .user-profile span {
      font-weight: 600;
      color: #ffaa00;
    }
    #matchList .playerInfo {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }
    #usernamePromptContainer input, #usernamePromptContainer button {
      margin: 4px 0;
    }
  </style>
</head>
<body>
  <div id="usernamePromptContainer">
    <h2 style="color:#ffaa00; margin-bottom:10px;">Enter Your Username</h2>
    <input id="usernameInput" type="text" maxlength="16" placeholder="Your username" />
    <input id="avatarUrlInput" type="text" placeholder="Avatar Image/GIF URL (optional)"
           style="margin:10px 0; padding:8px; width:100%; background:#1f1f2b; color:white; border:2px solid #ffaa00; border-radius:6px;" />
    <button id="usernameSubmit" disabled>Start Playing</button>
  </div>

  <div class="header" style="display:none;">
    <h1>Connect Four</h1>
    <div class="user-profile">
      <div class="avatar-circle" id="userAvatar">G</div>
      <span id="username">Guest</span>
    </div>
  </div>

  <div id="gameUI" style="display:none;">
    <div class="menu">
      <select id="rows"></select>
      <select id="cols"></select>
      <select id="mode">
        <option value="pvp">Player vs Player</option>
        <option value="ai">Player vs AI</option>
      </select>
      <button id="create">Create Game</button>
      <button id="leave" disabled>Leave Game</button>
    </div>

    <div id="matchList">
      <h3 style="color:#ffaa00;">Available Matches</h3>
      <button id="refreshMatchesBtn">Refresh Matches</button>
      <div id="matchesContainer" style="margin-top:10px;"></div>
    </div>

    <canvas id="gameCanvas" width="420" height="360" style="margin-top:20px; display:none;"></canvas>
    <div id="status" style="margin-top:10px;"></div>
  </div>

  <script>
    const usernameInput = document.getElementById('usernameInput');
    const avatarUrlInput = document.getElementById('avatarUrlInput');
    const usernameSubmit = document.getElementById('usernameSubmit');
    const usernameSpan = document.getElementById('username');
    const userAvatarDiv = document.getElementById('userAvatar');
    const usernamePrompt = document.getElementById('usernamePromptContainer');
    const gameUI = document.getElementById('gameUI');
    const header = document.querySelector('.header');
    const createBtn = document.getElementById('create');
    const leaveBtn = document.getElementById('leave');
    const matchList = document.getElementById('matchList');
    const matchesContainer = document.getElementById('matchesContainer');
    const refreshMatchesBtn = document.getElementById('refreshMatchesBtn');
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const status = document.getElementById('status');
    const rowSelect = document.getElementById('rows');
    const colSelect = document.getElementById('cols');
    const modeSelect = document.getElementById('mode');

    let currentUser = { username: '', avatarUrl: '' };
    let matches = {};
    let gameId = null;
    let myTurn = false;

    function getAvatarColor(name) {
      let hash = 0;
      for (let i = 0; i < name.length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
      }
      const colors = ['#f44336','#e91e63','#9c27b0','#673ab7','#3f51b5','#2196f3','#03a9f4','#00bcd4','#009688','#4caf50','#8bc34a','#cddc39','#ffeb3b','#ffc107','#ff9800','#ff5722'];
      return colors[Math.abs(hash) % colors.length];
    }

    function setUserProfile() {
      usernameSpan.textContent = currentUser.username;
      userAvatarDiv.innerHTML = '';
      if (currentUser.avatarUrl) {
        const img = document.createElement('img');
        img.src = currentUser.avatarUrl;
        userAvatarDiv.appendChild(img);
      } else {
        userAvatarDiv.textContent = currentUser.username.charAt(0).toUpperCase();
        userAvatarDiv.style.backgroundColor = getAvatarColor(currentUser.username);
      }
    }

    function renderMatchList() {
      matchesContainer.innerHTML = '';
      Object.keys(matches).forEach(id => {
        const match = matches[id];
        if (match.creator === currentUser.username) return;
        const div = document.createElement('div');
        const avatar = document.createElement('div');
        avatar.className = 'avatar-circle';
        avatar.textContent = match.creator.charAt(0).toUpperCase();
        avatar.style.backgroundColor = getAvatarColor(match.creator);
        avatar.style.width = '24px';
        avatar.style.height = '24px';
        avatar.style.fontSize = '14px';
        const span = document.createElement('span');
        span.textContent = match.creator;
        const btn = document.createElement('button');
        btn.textContent = 'Join';
        btn.onclick = () => joinMatch(id);
        const info = document.createElement('div');
        info.className = 'playerInfo';
        info.appendChild(avatar);
        info.appendChild(span);
        div.appendChild(info);
        div.appendChild(btn);
        matchesContainer.appendChild(div);
      });
    }

    function joinMatch(id) {
      const match = matches[id];
      if (!match) return;
      gameId = id;
      myTurn = false;
      matches[gameId].opponent = currentUser.username;
      renderMatchList();
      updateStatus(`${match.creator}'s turn`, match.creator);
      canvas.style.display = 'block';
    }

    function updateStatus(text, username) {
      status.innerHTML = `<div class="user-profile" style="display:inline-flex;transform:scale(0.85);"><div class="avatar-circle">${username.charAt(0).toUpperCase()}</div><span>${text}</span></div>`;
    }

    usernameInput.addEventListener('input', () => {
      usernameSubmit.disabled = usernameInput.value.trim().length < 2;
    });

    usernameSubmit.onclick = () => {
      currentUser.username = usernameInput.value.trim();
      currentUser.avatarUrl = avatarUrlInput.value.trim();
      usernamePrompt.style.display = 'none';
      header.style.display = 'flex';
      gameUI.style.display = 'block';
      setUserProfile();
      renderMatchList();
    };

    createBtn.onclick = () => {
      gameId = 'match_' + Math.random().toString(36).substr(2, 9);
      matches[gameId] = {
        creator: currentUser.username,
        avatar: currentUser.avatarUrl
      };
      myTurn = true;
      renderMatchList();
      updateStatus(`${currentUser.username}'s turn`, currentUser.username);
      canvas.style.display = 'block';
    };

    leaveBtn.onclick = () => {
      if (gameId && matches[gameId]) delete matches[gameId];
      gameId = null;
      canvas.style.display = 'none';
      status.textContent = '';
      renderMatchList();
    };

    refreshMatchesBtn.onclick = renderMatchList;

    for (let i = 4; i <= 8; i++) {
      const rowOpt = document.createElement('option');
      rowOpt.value = i;
      rowOpt.textContent = i;
      rowSelect.appendChild(rowOpt);
      const colOpt = document.createElement('option');
      colOpt.value = i + 1;
      colOpt.textContent = i + 1;
      colSelect.appendChild(colOpt);
    }
  </script>
</body>
</html>
